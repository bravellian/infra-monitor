@page
@using System.Text.Json
@model Bravellian.InfraMonitor.Pages.SqlServer.IndexModel
@{
    ViewData["Title"] = "SQL Server Report";
}

<component type="typeof(Bravellian.InfraMonitor.Components.SqlServer.SqlServerIndexBody)"
           render-mode="Static"
           param-HasStoredConnection="Model.HasStoredConnection"
           param-Overview="Model.Overview"
           param-ErrorMessage="Model.ErrorMessage"
           param-ErrorDetail="Model.ErrorDetail"
           param-ShowErrorDetail="Model.ShowErrorDetail"
           param-StorageMode="Model.StorageMode"
           param-LastSnapshotAt="Model.LastSnapshotAt" />

@if (Model.Overview is not null)
{
    @section Styles
    {
        <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css" />
    }

    @section Scripts
    {
        <script src="~/lib/chart.js/chart.umd.min.js" asp-append-version="true" nonce="@(ViewContext.HttpContext.Items["CspNonce"])"></script>
        <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js" nonce="@(ViewContext.HttpContext.Items["CspNonce"])"></script>
        <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js" nonce="@(ViewContext.HttpContext.Items["CspNonce"])"></script>
        <script nonce="@(ViewContext.HttpContext.Items["CspNonce"])">
            const waitLabels = @Html.Raw(JsonSerializer.Serialize(Model.Overview.TopWaits.Select(x => x.WaitType)));
            const waitValues = @Html.Raw(JsonSerializer.Serialize(Model.Overview.TopWaits.Select(x => x.WaitMs)));
            const dbLabels = @Html.Raw(JsonSerializer.Serialize(Model.Overview.TopDatabases.Select(x => x.Name)));
            const dbValues = @Html.Raw(JsonSerializer.Serialize(Model.Overview.TopDatabases.Select(x => x.SizeMb)));
            const historyLabels = @Html.Raw(JsonSerializer.Serialize(Model.SizeHistory.Select(x => x.CapturedAt.ToLocalTime().ToString("MM-dd HH:mm"))));
            const historyValues = @Html.Raw(JsonSerializer.Serialize(Model.SizeHistory.Select(x => x.Value)));

            new Chart(document.getElementById("waitsChart"), {
                type: "bar",
                data: {
                    labels: waitLabels,
                    datasets: [{
                        label: "Wait time (ms)",
                        data: waitValues,
                        backgroundColor: "rgba(235, 87, 87, 0.6)"
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            new Chart(document.getElementById("dbSizeChart"), {
                type: "bar",
                data: {
                    labels: dbLabels,
                    datasets: [{
                        label: "Size (MB)",
                        data: dbValues,
                        backgroundColor: "rgba(47, 111, 237, 0.6)"
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            const historyCanvas = document.getElementById("dbSizeHistoryChart");
            if (historyCanvas && historyValues.length > 0) {
                new Chart(historyCanvas, {
                    type: "line",
                    data: {
                        labels: historyLabels,
                        datasets: [{
                            label: "Total size (MB)",
                            data: historyValues,
                            borderColor: "#16a085",
                            backgroundColor: "rgba(22, 160, 133, 0.15)",
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }

            $(document).ready(function () {
                const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                tooltipTriggerList.forEach((tooltipTriggerEl) => {
                    new bootstrap.Tooltip(tooltipTriggerEl);
                });

                $(".js-data-table").DataTable({
                    pageLength: 10,
                    order: []
                });
            });
        </script>
    }
}
