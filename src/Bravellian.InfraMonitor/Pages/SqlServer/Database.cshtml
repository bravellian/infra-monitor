@page
@using System.Text.Json
@model Bravellian.InfraMonitor.Pages.SqlServer.DatabaseModel
@{
    ViewData["Title"] = "Database Report";
}

<component type="typeof(Bravellian.InfraMonitor.Components.SqlServer.SqlServerDatabaseBody)"
           render-mode="Static"
           param-HasStoredConnection="Model.HasStoredConnection"
           param-Name="Model.Name"
           param-DatabaseReport="Model.DatabaseReport"
           param-ErrorMessage="Model.ErrorMessage"
           param-ErrorDetail="Model.ErrorDetail"
           param-ShowErrorDetail="Model.ShowErrorDetail"
           param-StorageMode="Model.StorageMode"
           param-LastSnapshotAt="Model.LastSnapshotAt" />

@if (Model.DatabaseReport is not null)
{
    @section Styles
    {
        <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css" />
    }

    @section Scripts
    {
        <script src="~/lib/chart.js/chart.umd.min.js" asp-append-version="true" nonce="@(Context.Items["CspNonce"])"></script>
        <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js" nonce="@(Context.Items["CspNonce"])"></script>
        <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js" nonce="@(Context.Items["CspNonce"])"></script>
        <script nonce="@(Context.Items["CspNonce"])">
            const tableLabels = @Html.Raw(JsonSerializer.Serialize(Model.DatabaseReport.TopTables.Select(x => $"{x.SchemaName}.{x.TableName}")));
            const tableValues = @Html.Raw(JsonSerializer.Serialize(Model.DatabaseReport.TopTables.Select(x => x.TotalMb)));
            const indexLabels = @Html.Raw(JsonSerializer.Serialize(Model.DatabaseReport.TopIndexes.Select(x => $"{x.SchemaName}.{x.TableName}")));
            const indexValues = @Html.Raw(JsonSerializer.Serialize(Model.DatabaseReport.TopIndexes.Select(x => x.TotalMb)));
            const historyLabels = @Html.Raw(JsonSerializer.Serialize(Model.SizeHistory.Select(x => x.CapturedAt.ToLocalTime().ToString("MM-dd HH:mm"))));
            const historyValues = @Html.Raw(JsonSerializer.Serialize(Model.SizeHistory.Select(x => x.Value)));

            new Chart(document.getElementById("tableSizeChart"), {
                type: "bar",
                data: {
                    labels: tableLabels,
                    datasets: [{
                        label: "Size (MB)",
                        data: tableValues,
                        backgroundColor: "rgba(47, 111, 237, 0.6)"
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            new Chart(document.getElementById("indexSizeChart"), {
                type: "bar",
                data: {
                    labels: indexLabels,
                    datasets: [{
                        label: "Size (MB)",
                        data: indexValues,
                        backgroundColor: "rgba(255, 159, 64, 0.6)"
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            const historyCanvas = document.getElementById("dbSizeHistoryChart");
            if (historyCanvas && historyValues.length > 0) {
                new Chart(historyCanvas, {
                    type: "line",
                    data: {
                        labels: historyLabels,
                        datasets: [{
                            label: "Size (MB)",
                            data: historyValues,
                            borderColor: "#7d4cdb",
                            backgroundColor: "rgba(125, 76, 219, 0.15)",
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }

            $(document).ready(function () {
                const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                tooltipTriggerList.forEach((tooltipTriggerEl) => {
                    new bootstrap.Tooltip(tooltipTriggerEl);
                });

                $(".js-data-table").DataTable({
                    pageLength: 10,
                    order: []
                });
            });
        </script>
    }
}
